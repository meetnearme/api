(()=>{var re=Object.defineProperty;var U=Object.getOwnPropertySymbols;var oe=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var x=(n,e,t)=>e in n?re(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,f=(n,e)=>{for(var t in e||(e={}))oe.call(e,t)&&x(n,t,e[t]);if(U)for(var t of U(e))se.call(e,t)&&x(n,t,e[t]);return n};var u=(n,e,t)=>x(n,typeof e!="symbol"?e+"":e,t);var d=(n,e,t)=>new Promise((i,a)=>{var r=l=>{try{c(t.next(l))}catch(m){a(m)}},s=l=>{try{c(t.throw(l))}catch(m){a(m)}},c=l=>l.done?i(l.value):Promise.resolve(l.value).then(r,s);c((t=t.apply(n,e)).next())});var j={c:"country",e:"email",g:"gender",i:"external_id",n:["first_name","last_name"],p:"phone_number",r:["city","state","zip_code"],s:"street_address"},V={email:["email","e-mail","mail"],phone_number:["phone","tel","telephone","mobile","cell"],first_name:["first","fname","firstname","given"],last_name:["last","lname","lastname","family","surname"],street_address:["address","street","addr"],city:["city","town","locality"],state:["state","province","region"],zip_code:["zip","postal","postcode"],country:["country","nation"],gender:["gender","sex"],external_id:["id","userid","customer_id","user_id","member_id","account_id","external_id","reference","tracking_id"]};function ce(n){return n in V}function p(n,e){if(!n)return null;let t=n.toLowerCase(),i=f(f({},V),e);for(let[a,r]of Object.entries(i))if(r&&r.some(s=>t.includes(s))){if(a==="street_address"&&t.includes("email"))continue;if(ce(a))return a}return null}function le(n,e){let t=p(n.name,e);if(t)return t;let i=p(n.id,e);if(i)return i;let a=n.getAttribute("placeholder");if(a){let r=p(a,e);if(r)return r}return null}function L(n,e){if(!e)return!1;if(e==="1")return!0;if(e==="0")return!1;for(let[t,i]of Object.entries(j))if(Array.isArray(i)){if(i.includes(n)&&e.includes(t))return!0}else if(i===n&&e.includes(t))return!0;return!1}var g=class g{constructor(){u(this,"config");let e=g.DEBUG_FLAG_KEY,t=null;try{let l=localStorage.getItem(g.STORAGE_LEVEL_KEY);if(l){let m=JSON.parse(l);Date.now()-m.ts<3e5?t=m.level:localStorage.removeItem(g.STORAGE_LEVEL_KEY)}}catch(l){}let i=(()=>{try{return localStorage.getItem(e)==="1"}catch(l){return!1}})(),a=(()=>{try{return new URLSearchParams(window.location.search).get(e)==="1"}catch(l){return!1}})(),r=(()=>{try{let l=localStorage.getItem(g.STORAGE_OPTS_KEY);return l?JSON.parse(l):null}catch(l){return null}})(),s=i||t&&t!=="off"||a,c=t&&t!=="off"?t:i||a?"debug":"error";this.config={enabled:s,level:s?c:"error",prefix:"[Nextdoor Pixel]",includeTimestamp:!!(r!=null&&r.includeTimestamp),includeLocation:!!(r!=null&&r.includeLocation)}}formatPrefix(e){let t=[this.config.prefix,`[${e.toUpperCase()}]`];if(this.config.includeTimestamp)try{t.push(new Date().toISOString())}catch(i){}if(this.config.includeLocation){let i=this.getCallerLocation();i&&t.push(`(${i})`)}return t.join(" ")}getCallerLocation(){try{let e=new Error;if(!e.stack)return null;let t=e.stack.split(`
`).map(i=>i.trim());for(let i=1;i<t.length;i++){let a=t[i];if(!a||a.includes("basic/logger"))continue;let r=a.match(/\(?([^()]+):(\d+):(\d+)\)?$/);if(r){let s=r[1],c=r[2];return`${s}:${c}`}}return null}catch(e){return null}}shouldLog(e){if(!this.config.enabled)return!1;let t=["debug","info","warn","error"],i=t.indexOf(this.config.level);return t.indexOf(e)>=i}debug(e,...t){this.shouldLog("debug")&&(console.groupCollapsed(`${this.formatPrefix("debug")} ${e}`,...t),console.trace(),console.groupEnd())}info(e,...t){this.shouldLog("info")&&console.log(`${this.formatPrefix("info")} ${e}`,...t)}warn(e,...t){this.shouldLog("warn")&&console.warn(`${this.formatPrefix("warn")} ${e}`,...t)}error(e,...t){this.shouldLog("error")&&console.error(`${this.formatPrefix("error")} ${e}`,...t)}enableDebug(){this.config.enabled=!0,this.config.level="debug";try{localStorage.setItem("ndp_debug","1");let e={level:"debug",ts:Date.now()};localStorage.setItem(g.STORAGE_LEVEL_KEY,JSON.stringify(e))}catch(e){}console.log(`${this.config.prefix} Debug mode enabled`)}disable(){this.config.enabled=!1;try{localStorage.removeItem("ndp_debug");let e={level:"off",ts:Date.now()};localStorage.setItem(g.STORAGE_LEVEL_KEY,JSON.stringify(e))}catch(e){}}setLevel(e){if(e==="off")this.disable();else{this.config.enabled=!0,this.config.level=e;try{let t={level:e,ts:Date.now()};localStorage.setItem(g.STORAGE_LEVEL_KEY,JSON.stringify(t))}catch(t){}console.log(`${this.config.prefix} Log level set to '${e}'`)}}setOptions(e){try{typeof e.includeTimestamp=="boolean"&&(this.config.includeTimestamp=e.includeTimestamp),typeof e.includeLocation=="boolean"&&(this.config.includeLocation=e.includeLocation);let t={includeTimestamp:this.config.includeTimestamp,includeLocation:this.config.includeLocation};localStorage.setItem(g.STORAGE_OPTS_KEY,JSON.stringify(t)),console.log(`${this.config.prefix} Log options updated`,t)}catch(t){}}};u(g,"STORAGE_LEVEL_KEY","ndp_log_level"),u(g,"DEBUG_FLAG_KEY","ndp_debug"),u(g,"STORAGE_OPTS_KEY","ndp_log_opts");var h=g,o=new h;typeof window!="undefined"&&(window.ndpDebug=()=>(o.enableDebug(),"Nextdoor Pixel debug mode enabled. Check console for detailed logs."),window.ndpLog=n=>(o.setLevel(n),`Nextdoor Pixel log level set to '${n}'.`),window.ndpLogOptions=n=>(o.setOptions(n),"Nextdoor Pixel log options updated."),window.ndpReset=n=>{try{let e=[],t=()=>{try{localStorage.removeItem(h.DEBUG_FLAG_KEY)}catch(a){}try{localStorage.removeItem(h.STORAGE_LEVEL_KEY)}catch(a){}o.disable(),e.push("debug flags")},i=()=>{try{sessionStorage.removeItem("ndp_settings")}catch(a){}try{sessionStorage.removeItem("ndp_settings_expiry")}catch(a){}e.push("settings cache")};if(n)n==="debug"?t():n==="setting"&&i();else{t();try{localStorage.removeItem("gpuInfo")}catch(a){}try{localStorage.removeItem("ndp_session_id")}catch(a){}try{localStorage.removeItem("ndclid")}catch(a){}i(),e.push("gpuInfo","ndp_session_id","ndclid")}return`Nextdoor Pixel reset completed: ${e.join(", ")||n||"none"}`}catch(e){return"Nextdoor Pixel reset encountered an error (see console)."}});var de={ssn:[/^\d{3}-\d{2}-\d{4}$/,/^\d{3}\s\d{2}\s\d{4}$/,/^\d{9}$/],creditCard:[/^4[0-9]{12}(?:[0-9]{3})?$/,/^5[1-5][0-9]{14}$/,/^3[47][0-9]{13}$/,/^3[0-9]{13}$/,/^6(?:011|5[0-9]{2})[0-9]{12}$/,/^\d{4}\s\d{4}\s\d{4}\s\d{4}$/,/^\d{4}-\d{4}-\d{4}-\d{4}$/],driversLicense:[/^[A-Z]\d{7,8}$/,/^[A-Z]{2}\d{6,7}$/,/^\d{8,9}$/,/^[A-Z]\d{3}-\d{3}-\d{3}$/],medicalId:[/^MRN\d{6,10}$/i,/^PAT\d{6,10}$/i,/^PID\d{6,10}$/i],bankAccount:[/^\d{12,17}$/,/^\d{4}\s\d{4}\s\d{4}$/],passport:[/^[A-Z]{2}\d{7}$/],taxId:[/^\d{2}-\d{7}$/,/^\d{3}-\d{2}-\d{4}$/],insurance:[/^[A-Z]{2,3}\d{8,12}$/,/^POL\d{6,10}$/i,/^INS\d{6,10}$/i],sensitiveNumeric:[/^\d{16}$/,/^\d{15}$/,/^\d{9}$/]},ue=[/ssn/i,/social.?security/i,/tax.?id/i,/credit.?card/i,/card.?number/i,/ccn/i,/cvv/i,/cvc/i,/expiry/i,/expiration/i,/security.?code/i,/card.?code/i,/account.?number/i,/routing.?number/i,/bank.?account/i,/iban/i,/swift/i,/drivers?.?license/i,/dl.?number/i,/license.?number/i,/medical.?record/i,/patient.?id/i,/mrn/i,/health.?id/i,/insurance.?id/i,/passport/i,/passport.?number/i,/confidential/i,/secret/i,/private.?key/i,/password/i,/pin/i],ge=[/payment/i,/billing/i,/checkout/i,/credit/i,/bank/i,/medical/i,/health/i,/insurance/i,/tax/i,/government/i,/identity/i,/verification/i,/kyc/i,/background.?check/i];function me(n){return n?ue.some(e=>e.test(n)):!1}function pe(n){if(!n||typeof n!="string")return!1;let e=n.replace(/[\s-.]/g,"");for(let[t,i]of Object.entries(de))for(let a of i)if(a.test(e)||a.test(n))return o.warn(`Detected sensitive data pattern: ${t}`),!0;return!1}function S(){var e;let n=[document.title,document.URL,((e=document.querySelector('meta[name="description"]'))==null?void 0:e.getAttribute("content"))||""].join(" ").toLowerCase();return ge.some(t=>t.test(n))}function y(n,e){return me(n)?(o.warn(`Blocked sensitive field: ${n}`),!0):pe(e)?(o.warn(`Blocked sensitive value in field: ${n}`),!0):S()&&/^\d+$/.test(e.replace(/[\s-]/g,""))&&e.length>=8?(o.warn(`Blocked numeric data in sensitive context: ${n}`),!0):!1}var G=n=>{let e=/^[a-fA-F0-9]+$/,t=n.length;return!!({32:"MD5",40:"SHA-1",64:"SHA-256",128:"SHA-512"}[t]&&e.test(n))};function K(n,e=!0){return d(this,null,function*(){if(!n)return"";e&&(n=n.toLowerCase());let t=new TextEncoder().encode(n),i=yield window.crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(i)).map(s=>s.toString(16).padStart(2,"0")).join("")})}function _(n){if(!n||n.length>254)return!1;let e=n.split("@");if(e.length!==2)return!1;let[t,i]=e;return t.length>64||t.length===0||i.length>253||i.length===0?!1:/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(n)}function b(n){if(!n)return!1;let e=n.replace(/[\s\-+().]/g,"");return/^\d+$/.test(e)?e.length>=7&&e.length<=15:!1}var T={email:['input[type="email"]','input[name="email"]','input[id="email"]','input[name="user_email"]','input[name="customer_email"]','input[name="billing_email"]','input[name="contact_email"]','input[id="test_email"]','input[id*="contact-email"]','input[data-tid*="email"]','input[data-testid*="email"]','input[data-tag_item="email"]','input[formcontrolname*="email"]','input[aria-label*="email" i]','input[placeholder*="email" i]','input[name*="signInName"]'].join(", "),phone_number:['input[type="tel"]','input[name="phone"]','input[id="phone"]','input[name="phone_number"]','input[name="telephone"]','input[name="mobile"]','input[name="billing_phone"]','input[id="test_phone"]','input[id*="contact-phone"]','input[data-tid*="phone"]','input[data-testid*="phone"]','input[data-tag_item="phone_number"]','input[autocomplete="tel-national"]','input[name*="signInName"]'].join(", "),first_name:['input[name="first_name"]','input[id="first_name"]','input[name="fname"]','input[name="firstname"]','input[name="billing_first_name"]','input[id="test_first_name"]','input[name="fullName"]','input[data-testid*="name"]','input[autocomplete="name"]','input[data-tag_item="name"]'].join(", "),last_name:['input[name="last_name"]','input[id="last_name"]','input[name="lname"]','input[name="lastname"]','input[name="billing_last_name"]','input[id="test_last_name"]'].join(", "),street_address:['input[name="address"]','input[name="street_address"]','input[name="address_line_1"]','input[name="billing_address"]','input[name="shipping_address"]','input[id="test_street_address"]','input[formcontrolname="streetCtrl"]','input[placeholder*="street" i]','input[placeholder*="address" i]'].join(", "),city:['input[name="city"]','input[id="city"]','input[name="billing_city"]','input[name="shipping_city"]','input[id="test_city"]'].join(", "),state:['input[name="state"]','input[id="state"]','select[name="state"]','input[name="province"]','input[name="billing_state"]','input[name="shipping_state"]','input[id="test_state"]','select[data-testid*="state"]','select[formcontrolname*="state"]'].join(", "),zip_code:['input[name="zip"]','input[name="zip_code"]','input[name="postal_code"]','input[name="postcode"]','input[name="billing_zip"]','input[name="shipping_zip"]','input[id="test_zip_code"]','input[formcontrolname="zipCodeCtrl"]','input[data-testid*="zip"]','input[placeholder*="zip" i]','input[class*="zip-code"]'].join(", "),country:['select[name="country"]','input[name="country"]','select[name="billing_country"]','select[name="shipping_country"]','select[id="test_country"]'].join(", "),gender:['select[name="gender"]','input[name="gender"]','input[type="radio"][name="gender"]','select[id="test_gender"]'].join(", "),external_id:['input[name="user_id"]','input[name="customer_id"]','input[name="member_id"]','input[name="account_id"]','input[name="external_id"]','input[id="user_id"]','input[id="customer_id"]','input[id="member_id"]','input[name="reference_id"]','input[name="tracking_id"]','input[data-testid*="user-id"]','input[data-testid*="customer-id"]','input[placeholder*="id" i]','input[placeholder*="reference" i]'].join(", ")},M=['button[id="checkout"]','button[class*="checkout-btn"]','button[class*="checkout-button"]','input[type="submit"][value*="checkout"]','input[type="submit"][value*="order"]','button[id="purchase"]','button[class*="purchase-btn"]','button[class*="buy-now"]','input[type="submit"][value*="purchase"]'],Y={email:"email",e:"email",phone:"phone_number",p:"phone_number",fname:"first_name",lname:"last_name",first_name:"first_name",last_name:"last_name",user_id:"external_id",customer_id:"external_id",member_id:"external_id",account_id:"external_id",external_id:"external_id",uid:"external_id",ref:"external_id"};function I(n,e){new URLSearchParams(window.location.search).forEach((i,a)=>{let r=Y[a.toLowerCase()];r&&n(r)&&e(r,i)})}function w(n,e,t){new FormData(n).forEach((a,r)=>{let s=p(r);s&&e(s)&&t(s,a.toString())})}function C(n,e){document.querySelectorAll("form").forEach(i=>{i.querySelectorAll("input, select").forEach(r=>{let s=r;if(s.value){let c=p(s.name||s.id);if(c&&n(c)){if(y(c,s.value))return;e(c,s.value)}}})})}function B(n){var i,a,r,s,c,l,m,k,R,O,H,z;let e={name:((i=n.name)==null?void 0:i.toLowerCase())||"",id:((a=n.id)==null?void 0:a.toLowerCase())||"",type:((r=n.type)==null?void 0:r.toLowerCase())||"",placeholder:((s=n.placeholder)==null?void 0:s.toLowerCase())||"",ariaLabel:((c=n.getAttribute("aria-label"))==null?void 0:c.toLowerCase())||"",dataTestId:((l=n.getAttribute("data-testid"))==null?void 0:l.toLowerCase())||"",dataTid:((m=n.getAttribute("data-tid"))==null?void 0:m.toLowerCase())||"",dataTagItem:((k=n.getAttribute("data-tag_item"))==null?void 0:k.toLowerCase())||"",formControlName:((R=n.getAttribute("formcontrolname"))==null?void 0:R.toLowerCase())||"",autocomplete:((O=n.autocomplete)==null?void 0:O.toLowerCase())||"",className:((H=n.className)==null?void 0:H.toLowerCase())||"",value:((z=n.value)==null?void 0:z.toLowerCase())||""},t=Object.values(e).join(" ");return e.type==="email"||e.dataTagItem==="email"||/email/.test(t)||e.value&&_(e.value)?"email":e.type==="tel"||e.dataTagItem==="phone_number"||/phone|tel/.test(t)||e.value&&b(e.value)?"phone_number":e.dataTagItem==="name"||/fullname|name/.test(t)?"first_name":/zip|postal|postcode/.test(t)?"zip_code":/address|street/.test(t)?"street_address":n.tagName==="SELECT"&&/state/.test(t)?"state":/user.?id|customer.?id|member.?id|account.?id|external.?id|reference.?id|tracking.?id/.test(t)?"external_id":null}function Z(n){let e=n.options[n.selectedIndex];if(!(e!=null&&e.value)||e.disabled)return"";let t=Array.from(n.options).findIndex(s=>s.value&&!s.disabled)===n.selectedIndex,i=Array.from(n.options).slice(0,n.selectedIndex).some(s=>!s.value||s.disabled),a=n.hasAttribute("data-gtm-form-interact-field-id")||n.hasAttribute("data-analytics")||n.hasAttribute("data-track")||n.hasAttribute("data-ga")||n.hasAttribute("data-fb-track")||/track|analytics|gtm|ga-/.test(n.className)||/track|analytics|gtm|ga-/.test(n.id),r=/state/.test(n.name+n.id)&&(e.value==="AL"||e.value==="AB")||/country/.test(n.name+n.id)&&(e.value==="AF"||e.value==="US")||e.value&&e.value.length<=3&&e.textContent&&e.textContent.length>e.value.length*2;return t&&i&&(a||r)?"":e.value}function J(n){let e=n.trim();if(!e)return{};let t=e.split(/\s+/).filter(i=>i.length>0);return t.length===1?{first_name:t[0]}:t.length===2?{first_name:t[0],last_name:t[1]}:{first_name:t[0],last_name:t.slice(1).join(" ")}}function q(n,e,t){let i=B(n);if(!i||!e(i))return;let a="";if(n.tagName==="SELECT"?a=Z(n):a=n.value||"",!!a.trim())if(i==="first_name"&&a.includes(" ")){let r=J(a);r.first_name&&t("first_name",r.first_name),r.last_name&&e("last_name")&&t("last_name",r.last_name)}else t(i,a.trim())}function E(n,e){document.querySelectorAll("input, select, textarea").forEach(i=>{let a=i;a.type!=="password"&&a.value&&q(a,n,e)})}var W=["email","phone_number","first_name","last_name","gender","street_address","city","state","zip_code","country"];var F="ndp_settings",P="ndp_settings_expiry",X=300*1e3,D=new Map;function fe(n,e){try{let t=Q();t[n]=e,sessionStorage.setItem(F,JSON.stringify(t)),sessionStorage.setItem(P,(Date.now()+X).toString());let i=Object.keys(t).filter(a=>!a.startsWith("_"));o.debug("Cached settings for pixel:",n,{cacheSize:i.length,expiryTime:new Date(Date.now()+X).toISOString()})}catch(t){o.warn("Failed to cache settings:",t)}}function he(n){try{let e=sessionStorage.getItem(P);if(!e||Date.now()>parseInt(e))return _e(),null;let i=Q()[n];return i&&typeof i=="object"&&!Array.isArray(i)?i:null}catch(e){return null}}function Q(){try{let n=sessionStorage.getItem(F);if(!n)return{};let e=JSON.parse(n),t={};for(let i in e)e[i]&&typeof e[i]=="object"&&!Array.isArray(e[i])&&(t[i]=e[i]);return t}catch(n){return o.warn("Failed to parse cached settings:",n),{}}}function _e(){try{sessionStorage.removeItem(F),sessionStorage.removeItem(P),o.debug("Cleared settings cache")}catch(n){o.warn("Failed to clear settings cache:",n)}}function ee(n,e=3,t=1e3,i="https://ads.nextdoor.com/v2/api/conversions/settings"){return d(this,null,function*(){let a=he(n);if(a)return o.debug("Using cached settings for pixel:",n),a;let r=D.get(n);if(r)return o.debug("Joining existing settings request for pixel:",n),r;let s=d(null,null,function*(){try{o.debug("Starting new settings request for pixel:",n);let c=yield be(n,e,t,i);return fe(n,c),o.debug("Successfully fetched and cached settings for pixel:",n),c}catch(c){throw o.error("Failed to fetch settings for pixel:",n,c),c}finally{D.delete(n)}});return D.set(n,s),s})}function be(n,e=3,t=1e3,i="https://ads.nextdoor.com/v2/api/conversions/settings"){return d(this,null,function*(){let a=(r=0)=>d(null,null,function*(){try{o.debug("Fetching settings from server for pixel:",n);let s=typeof AbortSignal.timeout=="function"?AbortSignal.timeout(5e3):void 0,c=yield fetch(`${i}?id=${n}`,f({method:"GET",headers:{"Content-Type":"application/json"}},s&&{signal:s}));if(!c.ok)throw new Error(`Settings API returned ${c.status}: ${c.statusText}`);return yield c.json()}catch(s){return r<e?(o.debug(`Settings fetch failed, retrying... (${r+1}/${e})`),yield new Promise(c=>setTimeout(c,t)),a(r+1)):(o.warn("Unable to obtain settings from API. Falling back to default configuration."),{am:"0",em:{},t:Date.now()})}});return a()})}var $=class{constructor(e){u(this,"instances",new Map);u(this,"componentName");this.componentName=e,typeof window!="undefined"&&window.addEventListener("beforeunload",()=>{this.cleanup()})}getInstance(e,t){return d(this,null,function*(){if(!e)return o.warn(`No key provided for ${this.componentName} initialization`),null;let i=this.instances.get(e);if(i&&this.isInstanceValid(i))return o.debug(`Using existing ${this.componentName} instance for key:`,e),i;try{o.debug(`Starting ${this.componentName} initialization for key:`,e);let a=yield t();return this.isInstanceValid(a)?(this.instances.set(e,a),o.debug(`Successfully initialized ${this.componentName} for key:`,e),a):(o.warn(`${this.componentName} instance created but not valid for key:`,e),null)}catch(a){return o.error(`${this.componentName} initialization failed for key:`,e,a),null}})}getExistingInstance(e){let t=this.instances.get(e);return t&&this.isInstanceValid(t)?t:null}isInstanceValid(e){return typeof e.isEnabled=="function"?e.isEnabled():typeof e.isReady=="function"?e.isReady():!0}removeInstance(e){let t=this.instances.get(e);if(t){if(typeof t.cleanup=="function")try{t.cleanup()}catch(i){o.debug(`Failed to cleanup ${this.componentName} instance:`,i)}this.instances.delete(e),o.debug(`Removed ${this.componentName} instance for key:`,e)}}getInstanceCount(){return this.instances.size}getInstanceKeys(){return Array.from(this.instances.keys())}cleanup(){o.debug(`Cleaning up ${this.componentName} instances:`,this.instances.size),this.instances.forEach((e,t)=>{if(typeof e.cleanup=="function")try{e.cleanup()}catch(i){o.debug(`Failed to cleanup ${this.componentName} instance ${t}:`,i)}}),this.instances.clear(),o.debug(`${this.componentName} cleanup completed`)}};function te(n){return new $(n)}var ne=te("AdvancedMatching"),A=class A{constructor(e){u(this,"config",null);u(this,"dataSourceId");u(this,"collectedData",{});u(this,"processingEnabled",!1);this.dataSourceId=e}enableAutoCollection(){if(!this.processingEnabled)return;let e=()=>{E(t=>this.isFieldEnabled(t),(t,i)=>this.collectField(t,i)),this.attachFormListeners(),this.collectFromUrlParams(),this.attachCheckoutListeners(),this.setupPeriodicScanning()};if(document.readyState==="loading"){let t=()=>e();document.addEventListener("DOMContentLoaded",t)}else e()}attachFormListeners(){Object.entries(T).forEach(([e,t])=>{document.querySelectorAll(t).forEach(a=>{let r=s=>{let c=s.target;c.value&&this.isFieldEnabled(e)&&this.collectField(e,c.value)};a.addEventListener("blur",r)})})}attachCheckoutListeners(){let e=t=>{let i=t.target;this.collectFromForm(i)};document.addEventListener("submit",e),M.forEach(t=>{document.querySelectorAll(t).forEach(a=>{let r=()=>{setTimeout(()=>{this.collectFromCurrentPage()},A.CHECKOUT_BUTTON_DELAY)};a.addEventListener("click",r)})})}collectFromUrlParams(){I(e=>this.isFieldEnabled(e),(e,t)=>this.collectField(e,t))}collectFromForm(e){w(e,t=>this.isFieldEnabled(t),(t,i)=>this.collectField(t,i))}collectFromCurrentPage(){C(e=>this.isFieldEnabled(e),(e,t)=>this.collectField(e,t))}isFieldEnabled(e){var t;return L(e,(t=this.config)==null?void 0:t.am)}collectField(e,t){if(!(!t||!this.isFieldEnabled(e))){if(y(e,t)){o.warn(`Blocked sensitive data collection for field: ${e}`);return}if(e==="email"&&!_(t)){o.debug("Invalid email format rejected");return}if(e==="phone_number"&&!b(t)){o.debug("Invalid phone format rejected");return}if(!(e==="email"&&!_(t))&&!(e==="phone_number"&&!b(t))&&!(e==="zip_code"&&t.length>20)&&!(e==="external_id"&&!/^[a-zA-Z0-9_-]+$/.test(t))){if(e==="external_id"){if(t.length>100||t.length<2){o.debug(`External ID invalid length: ${t.length} characters`);return}if(!/^[a-zA-Z0-9_-]+$/.test(t)){o.debug("External ID contains invalid characters");return}}if(S()&&this.isHighRiskField(e,t)){o.warn(`Blocked data collection in sensitive context for field: ${e}`);return}this.collectedData[e]=t}}}isHighRiskField(e,t){return!!(e==="external_id"&&/^\d{6,}$/.test(t)||/^\d{8,}$/.test(t.replace(/[\s-]/g,"")))}getProcessedData(){return d(this,null,function*(){this.collectFromCurrentPage();let e={};for(let[t,i]of Object.entries(this.collectedData))i&&(W.includes(t)?G(i)?e[t]=i:e[t]=yield this.safeDigestMessage(i):e[t]=i);return e})}safeDigestMessage(e){return d(this,null,function*(){try{return yield K(e)}catch(t){return e}})}getConfig(){return this.config}setupPeriodicScanning(){let e=0,t=10,i=setInterval(()=>{if(e++,e>=t){clearInterval(i);return}E(a=>this.isFieldEnabled(a),(a,r)=>this.collectField(a,r))},2e3)}isEnabled(){return this.processingEnabled}initialize(){return d(this,null,function*(){try{o.debug("Initializing AdvancedMatching for pixel:",this.dataSourceId),this.config=yield ee(this.dataSourceId);let e=this.config.am;this.processingEnabled=!!e,o.debug("AdvancedMatching initialized",{dataSourceId:this.dataSourceId,enabled:this.processingEnabled,amConfig:e})}catch(e){o.warn("Advanced Matching initialization failed:",e),this.config={am:"0",em:{},t:Date.now()},this.processingEnabled=!1}})}cleanup(){this.collectedData={},this.processingEnabled=!1,this.config=null,o.debug("AdvancedMatching cleanup completed for pixel:",this.dataSourceId)}};u(A,"CHECKOUT_BUTTON_DELAY",100);var v=A;function N(n){return d(this,null,function*(){o.debug("Initializing advanced matching",{dataSourceId:n});let e=new v(n);return yield e.initialize(),e.isEnabled()&&e.enableAutoCollection(),o.debug("Advanced Matching initialized",{dataSourceId:n}),e})}function ie(n){return d(this,null,function*(){return ne.getInstance(n,()=>d(null,null,function*(){return N(n)}))})}function ae(n){return ne.getExistingInstance(n)}typeof window!="undefined"&&(window.NDPAdvancedMatching={AdvancedMatching:v,createAdvancedMatching:N,initAdvancedMatching:ie,getAdvancedMatchingInstance:ae});})();
