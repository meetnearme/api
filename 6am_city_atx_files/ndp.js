(()=>{var ae=Object.defineProperty,se=Object.defineProperties;var ce=Object.getOwnPropertyDescriptors;var V=Object.getOwnPropertySymbols;var de=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable;var C=(t,e,n)=>e in t?ae(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,A=(t,e)=>{for(var n in e||(e={}))de.call(e,n)&&C(t,n,e[n]);if(V)for(var n of V(e))le.call(e,n)&&C(t,n,e[n]);return t},F=(t,e)=>se(t,ce(e));var h=(t,e,n)=>C(t,typeof e!="symbol"?e+"":e,n);var g=(t,e,n)=>new Promise((r,o)=>{var a=s=>{try{d(n.next(s))}catch(p){o(p)}},c=s=>{try{d(n.throw(s))}catch(p){o(p)}},d=s=>s.done?r(s.value):Promise.resolve(s.value).then(a,c);d((n=n.apply(t,e)).next())});function P(){return`10000000-1000-4000-8000-${1e11}`.replace(/[018]/g,t=>{let e=crypto.getRandomValues(new Uint8Array(1))[0];return(+t^e&15>>+t/4).toString(16)})}var j=t=>{let e=/^[a-fA-F0-9]+$/,n=t.length;return!!({32:"MD5",40:"SHA-1",64:"SHA-256",128:"SHA-512"}[n]&&e.test(t))};function D(t,e=!0){return g(this,null,function*(){if(!t)return"";e&&(t=t.toLowerCase());let n=new TextEncoder().encode(t),r=yield window.crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(r)).map(c=>c.toString(16).padStart(2,"0")).join("")})}var _=()=>/Safari/i.test(window.navigator.userAgent)&&!/Chrome/i.test(window.navigator.userAgent);function k(t,e){let n=e.split("&");for(let r=0;r<n.length;r++){let o=n[r].split("=");if(o[0]===t)return o[1]}return null}function z(){let t=localStorage.getItem("gpuInfo");if(t)try{return JSON.parse(t)}catch(d){}let e=document.createElement("canvas"),n=null;for(let d of["webgl2","webgl","experimental-webgl"])try{let s=e.getContext(d);if(s&&(s instanceof WebGLRenderingContext||s instanceof WebGL2RenderingContext)){n=s;break}}catch(s){}if(!n)return null;let r="N/A",o="N/A",a=n.getExtension("WEBGL_debug_renderer_info");try{a?(r=n.getParameter(a.UNMASKED_VENDOR_WEBGL)||"N/A",o=n.getParameter(a.UNMASKED_RENDERER_WEBGL)||"N/A"):(r=n.getParameter(n.VENDOR)||"N/A",o=n.getParameter(n.RENDERER)||"N/A")}catch(d){}let c={vendor:r,renderer:o};return localStorage.setItem("gpuInfo",JSON.stringify(c)),c}var N=t=>Object.entries(t).map(([e,n])=>(n&&typeof n=="object"&&(n=JSON.stringify(n)),`${e}=${encodeURIComponent(n)}`)).join("&");function I(t,e,n="",r,o=!1){if(e==null)return;let a=[];a.push(`${t}=${e}`),n&&a.push(`expires=${n}`),a.push("path=/"),r&&a.push(`domain=${r}`),a.push("SameSite=Lax"),o&&a.push("Secure"),document.cookie=a.join(";")}function x(t){try{let e=document.cookie.split("; ").find(r=>r.startsWith(`${t}=`));return e?e.split("=")[1]:""}catch(e){return""}}function S(t,e,n){if(e==null)return;let r=new Date;r.setMonth(r.getMonth()+1);let a=n.replace("www.","").split(".");if(a.length===1){I(t,e,r.toUTCString(),void 0,!0);return}let c=`.${a.slice(-2).join(".")}`;I(t,e,r.toUTCString(),c,!0),!x(t)&&a.length>2&&(c=`.${a.slice(-3).join(".")}`,I(t,e,r.toUTCString(),c,!0)),_()&&localStorage&&localStorage.setItem(t,e)}var M="user_email_hash",G="user_email",m="ndclid",T="ndp_session_id",K=["order_value","product_context","order_id"],W=["email","phone_number","first_name","last_name","gender","street_address","city","state","zip_code","country"];var Y="Manual",b="https://flask.nextdoor.com/pixel";var $=class{constructor(){h(this,"pseudoMappings",{":nth-of-type(":":t(",":nth-last-child(":":l(",":nth-last-of-type(":":lt(",":nth-child(":":n("});h(this,"reverseMappings",this.buildReverseMappings());h(this,"regexCache",new Map)}buildReverseMappings(){let e={};for(let[n,r]of Object.entries(this.pseudoMappings))e[r]=n;return e["|"]=" ",e}getOrCreateRegex(e){this.regexCache.has(e)||this.regexCache.set(e,new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"));let n=this.regexCache.get(e);if(!n)throw new Error("Failed to create regex pattern");return n}toDSL(e){if(!e||e.trim()==="")return e;let n=e.trim();for(let[r,o]of Object.entries(this.pseudoMappings)){let a=this.getOrCreateRegex(r);n=n.replace(a,o)}return n=n.replace(/\s+/g,"|"),n=n.replace(/\s+/g,""),n}fromDSL(e){if(!e||e.trim()==="")return e;let n=e.trim(),r=Object.entries(this.pseudoMappings).map(([o,a])=>[a,o]).sort(([o],[a])=>a.length-o.length);for(let[o,a]of r)n=n.replace(new RegExp(o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),a);return n=n.replace(/\|/g," "),n}isValidDSL(e){return!e||e.trim()===""?!1:!/[$%^&*()_+={}[\]|\\:;"'<>?,./]/.test(e)}},Ne=new $;var ue=0;function E(){return Date.now()<ue}var Q=new Set;function O(t){let e={promise:t.catch(()=>{}),timestamp:Date.now()};return Q.add(e),t.finally(()=>{Q.delete(e)}),t}var l={debug:(...t)=>{},info:(...t)=>{},warn:(...t)=>{},error:(...t)=>{}},w=!1;if(typeof document!="undefined")try{document.addEventListener("visibilitychange",()=>{switch(document.visibilityState){case"visible":w=!1,l.debug("[http] document visible: disable beacon-friendly transport");break;case"hidden":w=!0,l.debug("[http] document hidden: enable beacon-friendly transport");break;default:w=!1}})}catch(t){}if(typeof window!="undefined")try{window.addEventListener("pagehide",()=>{w=!0,l.debug("[http] pagehide fired: enable beacon-friendly transport")}),window.addEventListener("pageshow",()=>{w=!1,l.debug("[http] pageshow fired: disable beacon-friendly transport")})}catch(t){}function ge(t){if(typeof t=="string")return t;try{return new URLSearchParams(t).toString()}catch(e){return String(t!=null?t:"")}}function U(t,e){return g(this,null,function*(){return typeof fetch!="function"?!1:(l.debug("[http] fetch keepalive attempt",{url:t,init:e}),fetch(t,e).then(()=>(l.debug("[http] fetch keepalive sent",{method:(e==null?void 0:e.method)||"GET",url:t,keepalive:(e==null?void 0:e.keepalive)===!0,pageHidden:w}),!0)).catch(n=>(l.debug("fetch keepalive failed:",n),!1)))})}function fe(t,e=1500){return l.debug("[http] using image fallback",{url:t,timeoutMs:e}),new Promise(n=>{try{let r=me(t),o=!1,a=()=>{o||(o=!0,n())},c=setTimeout(a,e);r.onload=()=>{clearTimeout(c),a()},r.onerror=()=>{clearTimeout(c),a()}}catch(r){n()}})}function pe(t,e,n="POST"){return l.debug("[http] using XHR fallback",{url:t,method:n}),new Promise(r=>{try{let o=new XMLHttpRequest;o.open(n,t),o.withCredentials=!0,o.onreadystatechange=function(){o.readyState===4&&(o.status!==204&&l.debug(`Request failed to ${t}.`),r())},o.onerror=()=>r(),n==="POST"?o.send(e!=null?e:""):o.send()}catch(o){r()}})}var he=t=>g(null,null,function*(){let e=b,n=g(null,null,function*(){if(l.debug("[http] POST requested",{src:e}),(w||E())&&typeof navigator!="undefined"&&"sendBeacon"in navigator)try{let o=new Blob([JSON.stringify(t)],{type:"application/json"}),a=navigator.sendBeacon(b,o);l.debug("[http] POST via sendBeacon",{ok:a,pageHidden:!0,preferBeacon:E()});return}catch(o){l.debug("[http] POST beacon failed, continue to fetch/xhr",o)}if(yield U(e,{method:"POST",mode:"no-cors",credentials:"include",keepalive:!0,body:JSON.stringify(t)})){l.debug("[http] POST using fetch keepalive");return}return l.debug("[http] POST falling back to XHR"),pe(b,JSON.stringify(t),"POST").catch(()=>{})});return O(n)}),me=t=>{let e=document.createElement("img");return e.src=t,e.alt="",e.style.display="none",e},be=t=>g(null,null,function*(){let e=ge(t),n=`${b}?${e}`,r=g(null,null,function*(){if(l.debug("[http] GET requested",{src:n}),(w||E())&&typeof navigator!="undefined"&&"sendBeacon"in navigator)try{let a=new Blob([e],{type:"application/x-www-form-urlencoded"}),c=navigator.sendBeacon(b,a);l.debug("[http] GET via sendBeacon (POST form body)",{ok:c,pageHidden:!0,preferBeacon:E()});return}catch(a){l.debug("[http] GET beacon failed, continue to fetch/img",a)}if(E()&&(yield U(b,{method:"POST",mode:"no-cors",credentials:"include",keepalive:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e}))){l.debug("[http] GET request sent as POST keepalive due to critical window");return}if(yield U(n,{method:"GET",mode:"no-cors",credentials:"include",keepalive:!0})){l.debug("[http] GET using fetch keepalive");return}return l.debug("[http] GET falling back to IMG"),fe(n,1500).catch(()=>{})});return O(r)}),J=(t,e)=>g(null,null,function*(){l.debug("[http] execute called",{method:e});let n;switch(e){case"POST":n=he(t);break;case"GET":n=be(t);break;default:return}return n.catch(()=>{})});var X="10.12";var f=class f{constructor(){h(this,"config");let e=f.DEBUG_FLAG_KEY,n=null;try{let s=localStorage.getItem(f.STORAGE_LEVEL_KEY);if(s){let p=JSON.parse(s);Date.now()-p.ts<3e5?n=p.level:localStorage.removeItem(f.STORAGE_LEVEL_KEY)}}catch(s){}let r=(()=>{try{return localStorage.getItem(e)==="1"}catch(s){return!1}})(),o=(()=>{try{return new URLSearchParams(window.location.search).get(e)==="1"}catch(s){return!1}})(),a=(()=>{try{let s=localStorage.getItem(f.STORAGE_OPTS_KEY);return s?JSON.parse(s):null}catch(s){return null}})(),c=r||n&&n!=="off"||o,d=n&&n!=="off"?n:r||o?"debug":"error";this.config={enabled:c,level:c?d:"error",prefix:"[Nextdoor Pixel]",includeTimestamp:!!(a!=null&&a.includeTimestamp),includeLocation:!!(a!=null&&a.includeLocation)}}formatPrefix(e){let n=[this.config.prefix,`[${e.toUpperCase()}]`];if(this.config.includeTimestamp)try{n.push(new Date().toISOString())}catch(r){}if(this.config.includeLocation){let r=this.getCallerLocation();r&&n.push(`(${r})`)}return n.join(" ")}getCallerLocation(){try{let e=new Error;if(!e.stack)return null;let n=e.stack.split(`
`).map(r=>r.trim());for(let r=1;r<n.length;r++){let o=n[r];if(!o||o.includes("basic/logger"))continue;let a=o.match(/\(?([^()]+):(\d+):(\d+)\)?$/);if(a){let c=a[1],d=a[2];return`${c}:${d}`}}return null}catch(e){return null}}shouldLog(e){if(!this.config.enabled)return!1;let n=["debug","info","warn","error"],r=n.indexOf(this.config.level);return n.indexOf(e)>=r}debug(e,...n){this.shouldLog("debug")&&(console.groupCollapsed(`${this.formatPrefix("debug")} ${e}`,...n),console.trace(),console.groupEnd())}info(e,...n){this.shouldLog("info")&&console.log(`${this.formatPrefix("info")} ${e}`,...n)}warn(e,...n){this.shouldLog("warn")&&console.warn(`${this.formatPrefix("warn")} ${e}`,...n)}error(e,...n){this.shouldLog("error")&&console.error(`${this.formatPrefix("error")} ${e}`,...n)}enableDebug(){this.config.enabled=!0,this.config.level="debug";try{localStorage.setItem("ndp_debug","1");let e={level:"debug",ts:Date.now()};localStorage.setItem(f.STORAGE_LEVEL_KEY,JSON.stringify(e))}catch(e){}console.log(`${this.config.prefix} Debug mode enabled`)}disable(){this.config.enabled=!1;try{localStorage.removeItem("ndp_debug");let e={level:"off",ts:Date.now()};localStorage.setItem(f.STORAGE_LEVEL_KEY,JSON.stringify(e))}catch(e){}}setLevel(e){if(e==="off")this.disable();else{this.config.enabled=!0,this.config.level=e;try{let n={level:e,ts:Date.now()};localStorage.setItem(f.STORAGE_LEVEL_KEY,JSON.stringify(n))}catch(n){}console.log(`${this.config.prefix} Log level set to '${e}'`)}}setOptions(e){try{typeof e.includeTimestamp=="boolean"&&(this.config.includeTimestamp=e.includeTimestamp),typeof e.includeLocation=="boolean"&&(this.config.includeLocation=e.includeLocation);let n={includeTimestamp:this.config.includeTimestamp,includeLocation:this.config.includeLocation};localStorage.setItem(f.STORAGE_OPTS_KEY,JSON.stringify(n)),console.log(`${this.config.prefix} Log options updated`,n)}catch(n){}}};h(f,"STORAGE_LEVEL_KEY","ndp_log_level"),h(f,"DEBUG_FLAG_KEY","ndp_debug"),h(f,"STORAGE_OPTS_KEY","ndp_log_opts");var R=f,u=new R;typeof window!="undefined"&&(window.ndpDebug=()=>(u.enableDebug(),"Nextdoor Pixel debug mode enabled. Check console for detailed logs."),window.ndpLog=t=>(u.setLevel(t),`Nextdoor Pixel log level set to '${t}'.`),window.ndpLogOptions=t=>(u.setOptions(t),"Nextdoor Pixel log options updated."),window.ndpReset=t=>{try{let e=[],n=()=>{try{localStorage.removeItem(R.DEBUG_FLAG_KEY)}catch(o){}try{localStorage.removeItem(R.STORAGE_LEVEL_KEY)}catch(o){}u.disable(),e.push("debug flags")},r=()=>{try{sessionStorage.removeItem("ndp_settings")}catch(o){}try{sessionStorage.removeItem("ndp_settings_expiry")}catch(o){}e.push("settings cache")};if(t)t==="debug"?n():t==="setting"&&r();else{n();try{localStorage.removeItem("gpuInfo")}catch(o){}try{localStorage.removeItem("ndp_session_id")}catch(o){}try{localStorage.removeItem("ndclid")}catch(o){}r(),e.push("gpuInfo","ndp_session_id","ndclid")}return`Nextdoor Pixel reset completed: ${e.join(", ")||t||"none"}`}catch(e){return"Nextdoor Pixel reset encountered an error (see console)."}});var i={ev:"",v:0,handleRequest:()=>{},ndclid:"",pid:"",pixelIdList:[],pl:"",cd:{},processQueue:()=>{},queue:[[]],rf:"",sem:"",ndclid_src:0,tz:"",screenWidth:0,screenHeight:0,gpuVendor:"",gpuRenderer:"",rdu:void 0,rduco:void 0,rdust:void 0},ye=t=>g(null,null,function*(){let e={};if(t){Object.entries(t).filter(([s])=>K.includes(s)).forEach(([s,p])=>{e[s]=p});let d=Object.entries(t).filter(([s])=>W.includes(s));if(d.length>0){let s=d.map(ie=>g(null,[ie],function*([v,L]){return j(L)?[v,L]:D(L).then(B=>[v,B]).catch(B=>null)}));(yield Promise.allSettled(s)).forEach(v=>{if(v.status==="fulfilled"&&v.value){let[L,ie]=v.value;e[L]=ie}})}}let n=i.pixelIdList||[],r=null;if(window.NDPAdvancedMatching)for(let c of n){let d=window.NDPAdvancedMatching.getAdvancedMatchingInstance(c);if(d!=null&&d.isEnabled()){r=d;break}}if(u.debug("Checking advanced matching...",{hasAdvancedMatching:!!r,isEnabled:r==null?void 0:r.isEnabled()}),!r||!r.isEnabled())return u.debug("Advanced matching not available or not enabled. Empty custom data is sent."),e;u.debug("Getting advanced matching data...");let o=new Promise((c,d)=>setTimeout(()=>d(new Error("Advanced matching timeout")),2e3)),a=yield Promise.race([r.getProcessedData(),o]);return u.debug("Advanced matching data received:",a),a?(Object.entries(a).forEach(([c,d])=>{!e[c]&&d&&(e[c]=d)}),e):(u.debug("Advanced matching timeout"),{})}),ve=()=>((!i.pageURL||i.pageURL!==window.location.href)&&(i.pageId=P(),i.pageURL=window.location.href),i.pageId),xe=()=>{let t="";return _()&&localStorage&&(t=localStorage.getItem(T)),t||(x(T)?t=x(T):(t=P(),S(T,t,window.location.hostname))),t},Se=(t,e,n,r)=>g(null,null,function*(){let o=N(A(A(A(F(A({pid:t,vrs:X,ev:e,pl:i.pl,v:i.v,ndclid:i.ndclid?i.ndclid:"",ndclid_src:i.ndclid_src||0,rf:i.rf,sem:i.sem||"",tm:i.sendPixelByGTM?"GTM":Y,iid:P(),pageid:ve(),sessionid:xe()},n&&n.event_id&&{eid:n.event_id}),{cd:yield ye(r),tz:i.tz,sw:i.screenWidth||0,sh:i.screenHeight||0,gpuV:i.gpuVendor||"",gpuR:i.gpuRenderer||""}),i.rdu!==void 0&&{rdu:i.rdu}),i.rduco!==void 0&&{rduco:i.rduco}),i.rdust!==void 0&&{rdust:i.rdust}));i.sendPixelByGTM?i.sendPixelByGTM(`${b}?${o}`):yield J(o,"GET")});function Z(t){let e;return e=k(m,location.search.substring(1)),e?(S(m,e,window.location.hostname),{ndclid:e,ndclid_src:1}):(e=k(m,decodeURIComponent(location.href)),e?(S(m,e,window.location.hostname),{ndclid:e,ndclid_src:1}):(e=k("ndclid",document.referrer),e?(S(m,e!=null?e:"",window.location.hostname),{ndclid:e,ndclid_src:1}):t.sendPixelByGTM&&t.getCookieValues&&([e]=t.getCookieValues(m),e)?{ndclid:e,ndclid_src:2}:_()&&localStorage&&(e=localStorage.getItem(m),e)?{ndclid:e,ndclid_src:2}:(e=x(m),e?{ndclid:e,ndclid_src:2}:{ndclid:"",ndclid_src:0})))}var ee=t=>{i.rf=document.referrer,i.tz=Intl.DateTimeFormat().resolvedOptions().timeZone||"",i.screenHeight=window.screen.height,i.screenWidth=window.screen.width;let e=z();e?(i.gpuVendor=e.vendor,i.gpuRenderer=e.renderer):(i.gpuVendor="",i.gpuRenderer=""),M in t?i.sem=t[M]:G in t&&(i.em=t[G]),Object.assign(i,Z(i))};function H(t,e,n){return g(this,null,function*(){if(typeof t=="string"&&(i.pl=location.href,crypto.subtle&&i.em&&!i.sem&&(i.sem=yield D(i.em)),t)){let r=i.pixelIdList;Array.isArray(e==null?void 0:e.pixel_ids)&&(r=e.pixel_ids,r.forEach(o=>{i.pixelIdList.indexOf(o)===-1&&i.pixelIdList.push(o)}));for(let o=0;o<r.length;o++){let a=r[o];yield Se(a,t,e,n)}}})}var y={};function ne(t){return g(this,null,function*(){let e="advancedMatching";if(y[e]){y[e]instanceof Promise&&(yield y[e]),yield te(t);return}y[e]=Ee();try{let n=yield y[e];y[e]=n,n&&(yield te(t))}catch(n){u.warn("Failed to load advanced matching module:",n),y[e]=!1}})}function Ee(){return new Promise(t=>{if(window.NDPAdvancedMatching){u.debug("Advanced matching module already loaded"),t(!0);return}let e=document.createElement("script"),n="js";e.src=`https://ads.nextdoor.com/v2/public/pixel/advmtch.${n}`,e.async=!0,e.onload=()=>{window.NDPAdvancedMatching?(u.debug("Advanced matching module loaded successfully"),t(!0)):(u.warn("Advanced matching module loaded but global not available"),t(!1))},e.onerror=r=>{u.warn("Failed to load advanced matching script:",r),t(!1)},document.head.appendChild(e),setTimeout(()=>{window.NDPAdvancedMatching||(u.warn("Advanced matching module load timeout"),t(!1))},1e4)})}function te(t){return g(this,null,function*(){if(!window.NDPAdvancedMatching){u.warn("Advanced matching module not available for initialization");return}try{(yield window.NDPAdvancedMatching.initAdvancedMatching(t))?u.debug("Advanced matching initialized successfully",{dataSourceId:t}):u.debug("Advanced matching initialization returned null (likely disabled)",{dataSourceId:t})}catch(e){u.warn("Advanced matching initialization failed:",e)}})}var Le=(t,e)=>g(null,null,function*(){i.pixelIdList.indexOf(t)===-1&&i.pixelIdList.push(t),ee(e),yield ne(t)}),Ae=(t,e,n)=>{t!==void 0&&(i.rdu=t),e!==void 0&&(i.rduco=e),n!==void 0&&(i.rdust=n)},Pe=t=>{t&&typeof t=="string"&&(i.ndclid=t,i.ndclid_src=1)},_e=t=>{let[e,...n]=t;if(!(!e||typeof e!="string")){for(;n.length<3;)n.push({});switch(e.toLowerCase()){case"init":{let[r,o]=n;return Le(r,o)}case"track":{let[r,o,a]=n;return H(r,o,a)}case"restricteddatausage":{let[r,o,a]=n;return Ae(r,o,a)}case"ndclid":{let[r]=n;return Pe(r)}default:break}}},re=()=>{if(Array.isArray(i.queue)&&i.queue.length>0){let t=i.queue.shift();if(t){let e=[...t];_e(e),i.processQueue()}}},q=(...t)=>{i.queue.push(t),i.processQueue()};var ke=(t,e)=>{var n;return t.ndp&&Object.assign(i,t.ndp),i.v=i.v||((n=t.ndp)==null?void 0:n.v),i.pixelIdList=i.pixelIdList||[],i.processQueue=re,i.handleRequest=q,t.ndp=q,{processQueue:i.processQueue}},oe=ke;try{oe(window,document).processQueue()}catch(t){console.log(t),console.log("Problem with request")}})();
